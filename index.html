<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Juego del Impostor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme {
            background-color: #1a1a1a;
            color: #ffffff;
        }

        .main-content {
            display: flex;
            gap: 20px;
            align-items: flex-start;
            max-width: 900px;
            width: 100%;
            justify-content: center;
            position: relative;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
            position: relative;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme .container {
            background: #2d2d2d;
            color: #ffffff;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        button {
            padding: 15px 30px;
            margin: 10px 0;
            font-size: 18px;
            width: 100%;
            max-width: 200px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        body.dark-theme button {
            background-color: #388E3C;
        }

        body.dark-theme button:hover {
            background-color: #2E7D32;
        }

        .player-status {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #e8f5e8;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #2e7d32;
            font-weight: bold;
            display: none;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme .player-status {
            background: #1b5e20;
            color: #ffffff;
            border-color: #4caf50;
        }

        .code-input, .number-input {
            padding: 12px;
            font-size: 18px;
            width: 250px;
            text-align: center;
            border: 2px solid #4CAF50;
            border-radius: 8px;
            margin: 20px 0;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        .code-input {
            text-transform: uppercase;
        }

        .number-input {
            width: 100px;
        }

        body.dark-theme .code-input,
        body.dark-theme .number-input {
            background-color: #3d3d3d;
            color: #ffffff;
            border-color: #4CAF50;
        }

        .result {
            margin: 20px 0;
            padding: 20px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 1.2em;
            transition: background-color 0.3s, color 0.3s;
        }

        .impostor {
            background-color: #ffebee;
            color: #c62828;
            border: 3px solid #c62828;
        }

        body.dark-theme .impostor {
            background-color: #4a1a1a;
            color: #ff6b6b;
            border-color: #ff6b6b;
        }

        .inocente {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 3px solid #2e7d32;
        }

        body.dark-theme .inocente {
            background-color: #1b3a1b;
            color: #66bb6a;
            border-color: #66bb6a;
        }

        .hidden {
            display: none !important;
        }

        .player-buttons {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            transition: color 0.3s;
        }

        body.dark-theme h1 {
            color: #ffffff;
        }

        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme .instructions {
            background: #1a237e;
            color: #ffffff;
            border-left-color: #5c6bc0;
        }

        .code-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #2196F3;
            margin: 15px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            border: 2px dashed #2196F3;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme .code-display {
            background: #1a237e;
            color: #90caf9;
            border-color: #5c6bc0;
        }

        .add-player-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #ddd;
            transition: border-color 0.3s;
        }

        body.dark-theme .add-player-section {
            border-top-color: #555;
        }

        .add-player-btn {
            background-color: #2196F3 !important;
            max-width: 250px !important;
        }

        .add-player-btn:hover {
            background-color: #1976D2 !important;
        }

        body.dark-theme .add-player-btn {
            background-color: #1565C0 !important;
        }

        body.dark-theme .add-player-btn:hover {
            background-color: #0D47A1 !important;
        }

        .player-count-info {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 15px;
            transition: color 0.3s;
        }

        body.dark-theme .player-count-info {
            color: #ccc;
        }

        /* Bot√≥n de tema oscuro */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #4CAF50;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        body.dark-theme .theme-toggle {
            background: #388E3C;
        }

        .theme-toggle::before {
            content: "üåô";
        }

        body.dark-theme .theme-toggle::before {
            content: "‚òÄÔ∏è";
        }

        /* Orden de jugadores - FUERA del contenedor principal */
        .player-order {
            background: #fff3e0;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #ff9800;
            width: 250px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transition: background-color 0.3s, color 0.3s;
            position: absolute;
            right: -280px;
            top: 0;
        }

        body.dark-theme .player-order {
            background: #3e2723;
            border-color: #ffb74d;
            color: #ffffff;
        }

        .player-order h3 {
            margin-top: 0;
            color: #e65100;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.3em;
            transition: color 0.3s;
        }

        body.dark-theme .player-order h3 {
            color: #ffb74d;
        }

        .order-list {
            text-align: left;
            list-style-type: none;
            padding: 0;
            margin: 0;
        }

        .order-item {
            padding: 12px 15px;
            margin: 8px 0;
            background: #ffe0b2;
            border-radius: 8px;
            border-left: 5px solid #ff9800;
            transition: all 0.3s ease;
            font-size: 1em;
        }

        body.dark-theme .order-item {
            background: #5d4037;
            border-left-color: #ffb74d;
        }

        .order-number {
            display: inline-block;
            width: 28px;
            height: 28px;
            background: #ff9800;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 28px;
            margin-right: 12px;
            font-weight: bold;
            font-size: 0.9em;
        }

        body.dark-theme .order-number {
            background: #ffb74d;
        }

        .current-player {
            background: #ffcc80 !important;
            font-weight: bold;
            transform: scale(1.02);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
            border-left: 5px solid #e65100 !important;
        }

        body.dark-theme .current-player {
            background: #8d6e63 !important;
            border-left-color: #ff9800 !important;
        }

        /* Centrar el contenedor principal */
        .centered-container {
            display: flex;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        /* Centrado vertical y horizontal para la pantalla de inicio */
        #stepStart {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 300px;
        }

        /* Estilos para informaci√≥n de partida */
        .game-info {
            background: #fff8e1;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ffa000;
            transition: background-color 0.3s, color 0.3s;
        }

        body.dark-theme .game-info {
            background: #3e2723;
            color: #ffffff;
            border-left-color: #ffb74d;
        }
    </style>
</head>
<body>
    <!-- Bot√≥n de tema oscuro -->
    <button class="theme-toggle" onclick="toggleTheme()"></button>

    <div class="main-content">
        <div class="centered-container">
            <div class="container">
                <!-- Estado de jugadores listos -->
                <div id="playerStatusContainer">
                    <!-- Los estados de jugadores se generar√°n din√°micamente -->
                </div>

                <!-- Paso 1: Bot√≥n Empezar -->
                <div id="stepStart">
                    <h1>üéÆ Juego del Impostor</h1>
                    <button onclick="startGame()">Empezar</button>
                </div>

                <!-- Paso 2: Selecci√≥n de jugador -->
                <div id="stepPlayerSelect" class="hidden">
                    <h1>Selecciona tu jugador</h1>
                    <div class="player-count-info" id="playerCountInfo">
                        Actualmente hay <span id="currentPlayerCount">4</span> jugadores
                    </div>
                    <div class="player-buttons" id="playerButtons">
                        <!-- Los botones de jugadores se generar√°n din√°micamente -->
                    </div>
                    
                    <div class="add-player-section">
                        <button class="add-player-btn" onclick="addPlayer()">‚ûï A√±adir otro jugador</button>
                        <p style="font-size: 0.8em; color: #666; margin-top: 10px;">
                            M√°ximo 10 jugadores
                        </p>
                    </div>
                </div>

                <!-- Paso 3: Para Jugador 1 - Seleccionar n√∫mero de jugadores -->
                <div id="stepPlayerCount" class="hidden">
                    <h1>Configurar Partida</h1>
                    <div class="instructions">
                        <p>üéØ <strong>Jugador 1 - Configura la partida</strong></p>
                        <p>¬øCu√°ntos jugadores van a jugar?</p>
                    </div>
                    <input type="number" id="totalPlayers" class="number-input" min="3" max="10" value="4">
                    <br>
                    <button onclick="setPlayerCount()">Crear Partida</button>
                </div>

                <!-- Paso 4: Input c√≥digo de partida -->
                <div id="stepCodeInput" class="hidden">
                    <h1>Unirse a partida</h1>
                    
                    <div id="createCodeSection" class="hidden">
                        <div class="instructions">
                            <p>üìù <strong>Instrucciones para el Jugador 1:</strong></p>
                            <p>1. Comparte este c√≥digo con los dem√°s jugadores</p>
                            <p>2. Despu√©s pulsa "Unirme a esta Partida"</p>
                        </div>
                        
                        <div id="codeDisplay">
                            <p>¬°Partida creada! Comparte este c√≥digo:</p>
                            <div id="gameCode" class="code-display"></div>
                            <button onclick="joinWithCreatedCode()">Unirme a esta Partida</button>
                        </div>
                    </div>

                    <div id="joinCodeSection">
                        <div class="instructions">
                            <p><strong>Para los dem√°s jugadores:</strong></p>
                            <p>Ingresa el c√≥digo que te comparti√≥ el Jugador 1:</p>
                        </div>
                        <input type="text" id="inputCode" class="code-input" placeholder="Ej: 03086NASFGD" maxlength="30">
                        <br>
                        <button onclick="joinGame()">Unirse con C√≥digo</button>
                    </div>
                </div>

                <!-- Paso 5: Mostrar resultado -->
                <div id="stepResult" class="hidden">
                    <h1>Tu rol es:</h1>
                    <div id="result" class="result"></div>
                    <button onclick="nextRound()">üîÑ Volver a Jugar</button>
                    <button onclick="newGame()" style="background-color: #757575; margin-top: 10px;">üè† Nueva Partida</button>
                </div>
            </div>

            <!-- Orden de jugadores - FUERA del contenedor principal pero dentro del centered-container -->
            <div id="playerOrder" class="player-order hidden">
                <h3>üéØ Orden de quien dice palabras</h3>
                <div id="orderList" class="order-list">
                    <!-- El orden de jugadores se generar√° aqu√≠ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // M√ÅS DE 100 PALABRAS SECRETAS - 3 categor√≠as ampliadas
        const palabras = [
            // CATEGOR√çA 1: ANIMALES Y NATURALEZA (35 palabras)
            "elefante", "dinosaurio", "jirafa", "delf√≠n", "mariposa", 
            "camale√≥n", "koala", "pinguino", "armadillo", "ornitorrinco",
            "leopardo", "canguro", "flamenco", "panda", "tuc√°n",
            "ballena", "pulpo", "ardilla", "erizo", "murci√©lago",
            "cebra", "hipop√≥tamo", "rinoceronte", "gorila", "chimpanc√©",
            "√°guila", "b√∫ho", "colibr√≠", "pavo real", "cisne",
            "cocodrilo", "serpiente", "tortuga", "rana", "salamandra",

            // CATEGOR√çA 2: OBJETOS Y TECNOLOG√çA (35 palabras)
            "bicicleta", "guitarra", "tel√©fono", "robot", "cohete",
            "paraguas", "br√∫jula", "telescopio", "meg√°fono", "tambor",
            "computadora", "teclado", "auriculares", "dron", "sat√©lite",
            "c√°mara", "micr√≥fono", "altavoz", "proyector", "impresora",
            "reloj", "espejo", "linterna", "maleta", "sombrilla",
            "martillo", "destornillador", "llave", "candado", "cuerda",
            "globo", "cometa", "yoyo", "rompecabezas", "domin√≥",

            // CATEGOR√çA 3: FANTAS√çA Y AVENTURA (35 palabras)
            "pirata", "sirena", "astronauta", "superh√©roe", "drag√≥n",
            "magia", "tesoro", "misterio", "aventura", "fantas√≠a",
            "hechicero", "caballero", "bruja", "hada", "duende",
            "unicornio", "fenix", "grifo", "quimera", "minotauro",
            "castillo", "fortaleza", "palacio", "templo", "pir√°mide",
            "espada", "escudo", "armadura", "corona", "anillo",
            "mapa", "br√∫jula", "bot√≠n", "medall√≥n", "gema"
        ];

        // Sistema de memoria para evitar repeticiones recientes
        let palabrasUsadasRecientemente = [];
        const MAX_PALABRAS_RECIENTES = 15;

        // Sistema de memoria para evitar que un jugador sea impostor dos veces seguidas
        let ultimoImpostor = 0;
        let historialImpostores = [];
        const MAX_HISTORIAL_IMPOSTORES = 20;

        // Sistema de rondas
        let rondaActual = 1;
        let jugadorSeleccionado = 0;
        let totalJugadoresPartida = 4;
        
        // Almacenar el c√≥digo actual para la siguiente ronda
        let codigoPartidaActual = "";
        
        let gameConfig = {
            palabraSecreta: "",
            jugadorImpostor: 0,
            codigo: "",
            ordenJugadores: []
        };

        // Array para almacenar los jugadores disponibles
        let jugadoresDisponibles = [1, 2, 3, 4];
        const MAX_JUGADORES = 10;

        // Funci√≥n para cambiar entre temas
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            // Guardar preferencia en localStorage
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('darkTheme', isDark);
        }

        // Cargar tema al iniciar
        function loadTheme() {
            const savedTheme = localStorage.getItem('darkTheme');
            if (savedTheme === 'true') {
                document.body.classList.add('dark-theme');
            }
        }

        // Llamar al cargar la p√°gina
        loadTheme();

        // Funci√≥n para generar un c√≥digo que incluya informaci√≥n del n√∫mero de jugadores
        // Ahora el c√≥digo comienza con dos d√≠gitos que representan el n√∫mero de jugadores (03..10)
        function generarCodigoConJugadores(semilla, numJugadores) {
            const letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let codigo = '';
            let hash = 0;
            
            // Incluir el n√∫mero de jugadores en el hash
            for (let i = 0; i < semilla.length; i++) {
                const char = semilla.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            hash = (hash + numJugadores * 1000) & hash;
            
            // Generar 3 n√∫meros basados en el hash (incluyendo info de jugadores)
            for (let i = 0; i < 3; i++) {
                const numero = Math.abs((hash + i * 13 + numJugadores * 7) % 10);
                codigo += numero;
            }
            
            // Generar 6 letras basadas en el hash (incluyendo info de jugadores)
            for (let i = 0; i < 6; i++) {
                const indiceLetra = Math.abs((hash + i * 17 + numJugadores * 11) % 26);
                codigo += letras[indiceLetra];
            }
            
            // Prefijar el n√∫mero de jugadores con 2 d√≠gitos (03..10)
            const numStr = String(numJugadores).padStart(2, '0');
            return numStr + codigo;
        }

        // Funci√≥n para extraer el n√∫mero de jugadores directamente desde los 2 primeros caracteres del c√≥digo
        function obtenerNumeroJugadoresDesdeCodigo(codigo) {
            if (!codigo || codigo.length < 2) return 4;
            const prefix = codigo.slice(0, 2);
            const num = parseInt(prefix, 10);
            if (!isNaN(num) && num >= 3 && num <= 10) {
                return num;
            }
            return 4;
        }

        // Funci√≥n para generar un orden determinista de jugadores
        function generarOrdenDeterminista(totalJugadores, semilla) {
            const jugadores = Array.from({length: totalJugadores}, (_, i) => i + 1);
            let hash = 0;
            
            // Crear hash de la semilla
            for (let i = 0; i < semilla.length; i++) {
                const char = semilla.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // Algoritmo de Fisher-Yates con semilla determinista
            for (let i = jugadores.length - 1; i > 0; i--) {
                const j = Math.abs((hash + i * 7)) % (i + 1);
                [jugadores[i], jugadores[j]] = [jugadores[j], jugadores[i]];
            }
            
            return jugadores;
        }

        // Funci√≥n para obtener una palabra determinista basada en el c√≥digo
        function obtenerPalabraDeterminista(codigo) {
            let hash = 0;
            
            // Crear hash del c√≥digo
            for (let i = 0; i < codigo.length; i++) {
                const char = codigo.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            
            // Usar el hash para seleccionar una palabra de la lista
            const indicePalabra = Math.abs(hash) % palabras.length;
            return palabras[indicePalabra];
        }

        // Funci√≥n para mostrar el orden de jugadores
        function mostrarOrdenJugadores() {
            const orderList = document.getElementById('orderList');
            const playerOrder = document.getElementById('playerOrder');
            
            orderList.innerHTML = '';
            
            gameConfig.ordenJugadores.forEach((jugador, index) => {
                const orderItem = document.createElement('div');
                orderItem.className = 'order-item';
                
                if (jugador === jugadorSeleccionado) {
                    orderItem.classList.add('current-player');
                }
                
                orderItem.innerHTML = `
                    <span class="order-number">${index + 1}</span>
                    Jugador ${jugador} ${jugador === jugadorSeleccionado ? ' (T√ö)' : ''}
                `;
                
                orderList.appendChild(orderItem);
            });
            
            // Mostrar la secci√≥n de orden
            playerOrder.classList.remove('hidden');
        }

        // Funci√≥n para renderizar los botones de jugadores
        function renderPlayerButtons() {
            const playerButtonsContainer = document.getElementById('playerButtons');
            const playerStatusContainer = document.getElementById('playerStatusContainer');
            const playerCountInfo = document.getElementById('playerCountInfo');
            
            // Limpiar contenedores
            playerButtonsContainer.innerHTML = '';
            playerStatusContainer.innerHTML = '';
            
            // Actualizar informaci√≥n del contador
            document.getElementById('currentPlayerCount').textContent = jugadoresDisponibles.length;
            
            // Crear botones y estados para cada jugador
            jugadoresDisponibles.forEach(jugador => {
                // Crear bot√≥n del jugador
                const button = document.createElement('button');
                button.textContent = `Jugador ${jugador}`;
                button.onclick = () => selectPlayer(jugador);
                playerButtonsContainer.appendChild(button);
                
                // Crear estado del jugador
                const status = document.createElement('div');
                status.id = `player${jugador}Status`;
                status.className = 'player-status';
                status.textContent = `Jugador ${jugador} Listo`;
                playerStatusContainer.appendChild(status);
            });
        }

        // Funci√≥n para a√±adir un nuevo jugador
        function addPlayer() {
            if (jugadoresDisponibles.length < MAX_JUGADORES) {
                const nuevoJugador = jugadoresDisponibles.length + 1;
                jugadoresDisponibles.push(nuevoJugador);
                renderPlayerButtons();
            } else {
                alert(`M√°ximo ${MAX_JUGADORES} jugadores permitidos`);
            }
        }

        // Funci√≥n MEJORADA para seleccionar impostor con probabilidad <7% de repetici√≥n
        function seleccionarImpostorJusto(codigoCompleto, totalJugadores) {
            // Crear un hash robusto del c√≥digo
            let hash = 0;
            for (let i = 0; i < codigoCompleto.length; i++) {
                const char = codigoCompleto.charCodeAt(i);
                hash = ((hash << 7) - hash) + char;
                hash = hash & hash;
            }
            
            // Generar candidatos posibles (excluyendo al √∫ltimo impostor)
            const candidatos = [];
            for (let i = 1; i <= totalJugadores; i++) {
                if (i !== ultimoImpostor) {
                    candidatos.push(i);
                }
            }
            
            // Si hay candidatos disponibles, elegir uno aleatoriamente
            if (candidatos.length > 0) {
                const indiceCandidato = Math.abs(hash) % candidatos.length;
                const nuevoImpostor = candidatos[indiceCandidato];
                
                // Actualizar historial
                ultimoImpostor = nuevoImpostor;
                historialImpostores.push(nuevoImpostor);
                
                // Mantener el historial bajo control
                if (historialImpostores.length > MAX_HISTORIAL_IMPOSTORES) {
                    historialImpostores.shift();
                }
                
                return nuevoImpostor;
            } else {
                // Caso extremo: solo hay un jugador (el √∫ltimo impostor)
                // En este caso, forzamos que sea impostor de nuevo
                return ultimoImpostor;
            }
        }

        // Funci√≥n para generar la siguiente partida de manera determinista
        function generarSiguientePartida() {
            // Si ya tenemos un c√≥digo actual, usarlo como semilla para el siguiente
            let semilla;
            if (codigoPartidaActual) {
                // Usar el c√≥digo actual como semilla para generar el siguiente
                semilla = codigoPartidaActual + rondaActual;
            } else {
                // Primera partida, usar semilla aleatoria
                semilla = Date.now().toString();
            }
            
            // Generar c√≥digo determinista que incluya info de jugadores
            const nuevoCodigo = generarCodigoConJugadores(semilla, totalJugadoresPartida);
            
            // Generar palabra secreta determinista basada en el c√≥digo
            const palabraSecreta = obtenerPalabraDeterminista(nuevoCodigo);
            
            // Determinar impostor usando el sistema MEJORADO
            const jugadorImpostor = seleccionarImpostorJusto(nuevoCodigo, totalJugadoresPartida);

            // Generar orden determinista de jugadores - ¬°ESTA ES LA CLAVE!
            // Usamos el MISMO c√≥digo para generar el MISMO orden para todos
            const ordenJugadores = generarOrdenDeterminista(totalJugadoresPartida, nuevoCodigo);

            // Guardar el nuevo c√≥digo como actual
            codigoPartidaActual = nuevoCodigo;
            
            return {
                palabraSecreta: palabraSecreta,
                jugadorImpostor: jugadorImpostor,
                codigo: nuevoCodigo,
                ordenJugadores: ordenJugadores
            };
        }

        function startGame() {
            document.getElementById('stepStart').classList.add('hidden');
            document.getElementById('stepPlayerSelect').classList.remove('hidden');
            // Ocultar orden de jugadores
            document.getElementById('playerOrder').classList.add('hidden');
            // Renderizar los botones de jugadores al iniciar
            renderPlayerButtons();
        }

        function selectPlayer(numero) {
            jugadorSeleccionado = numero;
            
            // Mostrar el estado del jugador seleccionado
            document.getElementById(`player${numero}Status`).style.display = 'block';
            
            // Ocultar selecci√≥n de jugador
            document.getElementById('stepPlayerSelect').classList.add('hidden');
            
            if (numero === 1) {
                // Si es Jugador 1, mostrar configuraci√≥n de n√∫mero de jugadores
                document.getElementById('stepPlayerCount').classList.remove('hidden');
                // Actualizar el valor por defecto con el n√∫mero actual de jugadores
                document.getElementById('totalPlayers').value = jugadoresDisponibles.length;
            } else {
                // Si es otro jugador, mostrar directamente la pantalla de c√≥digo
                document.getElementById('stepCodeInput').classList.remove('hidden');
                document.getElementById('createCodeSection').classList.add('hidden');
                document.getElementById('joinCodeSection').classList.remove('hidden');
            }
            
            // Ocultar orden de jugadores
            document.getElementById('playerOrder').classList.add('hidden');
        }

        function setPlayerCount() {
            const count = parseInt(document.getElementById('totalPlayers').value);
            
            if (count < 3 || count > 10 || isNaN(count)) {
                alert("Por favor, introduce un n√∫mero entre 3 y 10");
                return;
            }
            
            totalJugadoresPartida = count;
            
            // Crear el c√≥digo de partida autom√°ticamente
            createGameCode();
        }

        function createGameCode() {
            // Generar nueva configuraci√≥n de partida
            const nuevaConfig = generarSiguientePartida();
            
            // Guardar configuraci√≥n
            gameConfig = nuevaConfig;

            // Ocultar configuraci√≥n y mostrar c√≥digo
            document.getElementById('stepPlayerCount').classList.add('hidden');
            document.getElementById('stepCodeInput').classList.remove('hidden');
            document.getElementById('createCodeSection').classList.remove('hidden');
            document.getElementById('joinCodeSection').classList.add('hidden');
            
            // Mostrar el c√≥digo
            document.getElementById('gameCode').textContent = gameConfig.codigo;
        }

        function joinWithCreatedCode() {
            // El Jugador 1 se une a su propia partida creada
            mostrarResultado();
        }

        function joinGame() {
            const inputCode = document.getElementById('inputCode').value.toUpperCase().trim();
            
            // Ahora los c√≥digos llevan prefijo de 2 d√≠gitos con el n√∫mero de jugadores,
            // por eso validamos longitud m√≠nima 11 (2 + 9)
            if (inputCode.length < 11) {
                alert("C√≥digo inv√°lido. Debe tener al menos 11 caracteres (ej: 03086NASFGD)");
                return;
            }

            // Guardar el c√≥digo actual para la siguiente ronda
            codigoPartidaActual = inputCode;

            // Extraer el n√∫mero de jugadores del c√≥digo (ahora a partir del prefijo de 2 d√≠gitos)
            const numJugadoresExtraido = obtenerNumeroJugadoresDesdeCodigo(inputCode);
            
            // Actualizar el n√∫mero de jugadores con el valor extra√≠do del c√≥digo
            totalJugadoresPartida = numJugadoresExtraido;

            // Generar palabra secreta determinista basada en el c√≥digo
            const palabraSecreta = obtenerPalabraDeterminista(inputCode);

            // Determinar impostor usando el sistema MEJORADO con probabilidad <7%
            const jugadorImpostor = seleccionarImpostorJusto(inputCode, totalJugadoresPartida);

            // Generar orden determinista de jugadores - ¬°USANDO EL MISMO C√ìDIGO!
            const ordenJugadores = generarOrdenDeterminista(totalJugadoresPartida, inputCode);

            // Guardar configuraci√≥n
            gameConfig.palabraSecreta = palabraSecreta;
            gameConfig.jugadorImpostor = jugadorImpostor;
            gameConfig.codigo = inputCode;
            gameConfig.ordenJugadores = ordenJugadores;

            mostrarResultado();
        }

        function mostrarResultado() {
            // Ocultar todas las pantallas y mostrar resultado
            document.getElementById('stepCodeInput').classList.add('hidden');
            document.getElementById('stepResult').classList.remove('hidden');
            
            const resultado = document.getElementById('result');
            
            if (jugadorSeleccionado === gameConfig.jugadorImpostor) {
                resultado.innerHTML = `
                    <h2>üé≠ IMPOSTOR</h2>
                    <p>No conoces la palabra secreta</p>
                    <p><small>Que no te descubran ü§´</small></p>
                    <div class="game-info">
                        <p>C√≥digo: ${gameConfig.codigo}</p>
                        <p>Jugadores: ${totalJugadoresPartida}</p>
                    </div>
                `;
                resultado.className = 'result impostor';
            } else {
                resultado.innerHTML = `
                    <h2>‚úÖ INOCENTE</h2>
                    <p>La palabra secreta es:</p>
                    <h1 style="font-size: 1.8em; margin: 10px 0;">"${gameConfig.palabraSecreta}"</h1>
                    <p><small>Da pistas relacionadas con esta palabra</small></p>
                    <div class="game-info">
                        <p>C√≥digo: ${gameConfig.codigo}</p>
                        <p>Jugadores: ${totalJugadoresPartida}</p>
                    </div>
                `;
                resultado.className = 'result inocente';
            }
            
            // Mostrar el orden de jugadores - ¬°SIEMPRE EL MISMO PARA TODOS!
            mostrarOrdenJugadores();
        }

        // Funci√≥n para la siguiente ronda - TODOS obtienen el mismo c√≥digo y misma palabra
        function nextRound() {
            rondaActual++;
            
            // Generar nueva configuraci√≥n usando el c√≥digo actual como semilla
            const nuevaConfig = generarSiguientePartida();
            
            // Aplicar la nueva configuraci√≥n
            gameConfig = nuevaConfig;
            
            // Mostrar resultado directamente
            mostrarResultado();
        }

        // Funci√≥n para nueva partida (reinicia el ciclo)
        function newGame() {
            // Reiniciar variables para nueva partida
            rondaActual = 1;
            codigoPartidaActual = "";
            ultimoImpostor = 0;
            
            // Generar nueva configuraci√≥n
            const nuevaConfig = generarSiguientePartida();
            gameConfig = nuevaConfig;
            mostrarResultado();
        }

        // Funci√≥n para resetear completamente (volver a selecci√≥n de jugador)
        function resetGame() {
            // Resetear variables
            rondaActual = 1;
            jugadorSeleccionado = 0;
            totalJugadoresPartida = 4;
            codigoPartidaActual = "";
            ultimoImpostor = 0;
            gameConfig = { 
                palabraSecreta: "", 
                jugadorImpostor: 0, 
                codigo: "",
                ordenJugadores: []
            };
            
            // Resetear inputs
            document.getElementById('totalPlayers').value = '4';
            document.getElementById('inputCode').value = '';
            
            // Resetear jugadores a los 4 iniciales
            jugadoresDisponibles = [1, 2, 3, 4];
            
            // Ocultar resultado y mostrar selecci√≥n de jugador
            document.getElementById('stepResult').classList.add('hidden');
            document.getElementById('stepPlayerSelect').classList.remove('hidden');
            
            // Ocultar orden de jugadores
            document.getElementById('playerOrder').classList.add('hidden');
            
            // Ocultar estados de jugadores
            const statusElements = document.querySelectorAll('.player-status');
            statusElements.forEach(status => {
                status.style.display = 'none';
            });
            
            renderPlayerButtons();
        }

        // Permitir usar Enter en los inputs
        document.getElementById('totalPlayers').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                setPlayerCount();
            }
        });

        document.getElementById('inputCode').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                joinGame();
            }
        });
    </script>
</body>
</html>
